name: build-and-push-to-gitee-delta

on:
  # 仅手动触发
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写权限来创建和推送 tag

    steps:
      - name: Checkout isw_v2 源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整 git 历史，用于创建 tag

      - name: 安装 Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 安装编译依赖 (Cython, setuptools)
        run: |
          python -m pip install --upgrade pip
          # 优先使用官方 PyPI，避免国内镜像上 Cython 版本不全导致安装失败
          pip install --no-cache-dir "cython==3.0.11" setuptools || \
          pip install --no-cache-dir cython setuptools

      - name: 获取 isw-helper 编译工具
        run: |
          set -e
          echo "克隆 isw-helper 仓库..."
          rm -rf /tmp/isw-helper
          git clone --depth 1 https://gitee.com/hotanzn/isw-helper.git /tmp/isw-helper

          if [ ! -f "/tmp/isw-helper/build_cython_delta.py" ]; then
            echo "错误: /tmp/isw-helper 中未找到 build_cython_delta.py"
            exit 1
          fi

      - name: 检查 latest_build tag 并准备增量编译
        run: |
          set -e
          CURRENT_COMMIT="${{ github.sha }}"
          LATEST_BUILD_TAG="latest_build"
          
          echo "当前 commit: $CURRENT_COMMIT"
          echo "检查 latest_build tag..."
          
          # 检查 latest_build tag 是否存在
          if git rev-parse "$LATEST_BUILD_TAG" >/dev/null 2>&1; then
            LATEST_BUILD_COMMIT=$(git rev-parse "$LATEST_BUILD_TAG")
            echo "找到 latest_build tag，指向 commit: $LATEST_BUILD_COMMIT"
            
            # 如果 latest_build tag 就是当前 commit，直接终止
            if [ "$LATEST_BUILD_COMMIT" = "$CURRENT_COMMIT" ]; then
              echo "latest_build tag 指向当前 commit，无需编译，直接终止"
              echo "SKIP_BUILD=true" >> $GITHUB_ENV
              exit 0
            fi
            
            echo "LATEST_BUILD_COMMIT=$LATEST_BUILD_COMMIT" >> $GITHUB_ENV
            echo "将进行增量编译，比较 $LATEST_BUILD_COMMIT 和 $CURRENT_COMMIT 之间的变化"
          else
            echo "未找到 latest_build tag，将进行全量编译"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: 获取已编译的目标仓库（用于增量编译）
        if: env.SKIP_BUILD != 'true'
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USER: children1987
        run: |
          set -e
          DIST_DIR="/tmp/isw_v2-dist"
          TEMP_CLONE="/tmp/eztcloud-dist-clone"
          
          if [ -z "$GITEE_TOKEN" ]; then
            echo "警告: GITEE_TOKEN 未设置，将进行全量编译"
            rm -rf "$DIST_DIR"
            mkdir -p "$DIST_DIR"
          else
            echo "克隆 Gitee 目标仓库以获取已编译文件（用于增量编译）..."
            rm -rf "$TEMP_CLONE" "$DIST_DIR"
            if git clone --depth 1 "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/hotanzn/eztcloud-dist.git" "$TEMP_CLONE" 2>/dev/null; then
              # 只复制内容，不包括 .git 目录
              mkdir -p "$DIST_DIR"
              if [ -d "$TEMP_CLONE" ] && [ "$(ls -A "$TEMP_CLONE" 2>/dev/null | grep -v '^\.git$')" ]; then
                # 复制除 .git 外的所有内容
                rsync -a --exclude='.git' "$TEMP_CLONE/" "$DIST_DIR/" || \
                (cd "$TEMP_CLONE" && find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec cp -r {} "$DIST_DIR/" \;)
                echo "已获取目标仓库内容，将进行增量编译"
              else
                echo "目标仓库为空，将进行全量编译"
                rm -rf "$DIST_DIR"
                mkdir -p "$DIST_DIR"
              fi
              rm -rf "$TEMP_CLONE"
            else
              echo "目标仓库不存在或无法访问，将进行全量编译"
              rm -rf "$DIST_DIR"
              mkdir -p "$DIST_DIR"
            fi
          fi

      - name: 增量编译 isw_v2 源码为 .so
        if: env.SKIP_BUILD != 'true'
        env:
          LATEST_BUILD_COMMIT: ${{ env.LATEST_BUILD_COMMIT }}
        run: |
          set -e
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          DIST_DIR="/tmp/isw_v2-dist"
          CURRENT_COMMIT="${{ github.sha }}"
          
          echo "当前 commit: $CURRENT_COMMIT"
          if [ -n "$LATEST_BUILD_COMMIT" ]; then
            echo "上次编译时的 commit (latest_build tag): $LATEST_BUILD_COMMIT"
          else
            echo "未找到 latest_build tag，将进行全量编译"
          fi

          cd /tmp/isw-helper

          # 如果有 latest_build commit，传递给编译脚本
          if [ -n "$LATEST_BUILD_COMMIT" ]; then
            python build_cython_delta.py \
              --source "$GITHUB_WORKSPACE" \
              --target "$DIST_DIR" \
              --platform linux \
              --exclude "test" \
              --exclude "tests" \
              --exclude "__pycache__" \
              --exclude ".git" \
              --last-commit "$LATEST_BUILD_COMMIT"
          else
            python build_cython_delta.py \
              --source "$GITHUB_WORKSPACE" \
              --target "$DIST_DIR" \
              --platform linux \
              --exclude "test" \
              --exclude "tests" \
              --exclude "__pycache__" \
              --exclude ".git"
          fi

          echo "编译完成，输出目录: $DIST_DIR"

      - name: 清理多余的 .py 源码文件
        run: |
          set -e
          DIST_DIR="/tmp/isw_v2-dist"
          echo "开始清理多余的 .py 文件，目录: $DIST_DIR"

          # 删除那些已经有对应 .so 的 .py，只保留少量必要入口文件
          find "$DIST_DIR" -name "*.py" | while read -r py; do
            base="$(basename "$py")"

            # 注意：deploy 目录下的文件已在编译阶段统一保留为源码（build_cython_delta.py::_should_keep）
            # 不会被编译，因此不会有对应的 .so，清理阶段也不会删除它们，无需在此保护

            stem="${py%.py}"
            # 同目录下存在同名的 cpython-*.so 或 .so，则认为 .py 可以删除
            if compgen -G "${stem}.cpython-"*".so" > /dev/null || [ -f "${stem}.so" ]; then
              echo "删除多余源码: $py"
              rm -f "$py"
            fi
          done

          echo "清理完成"

      - name: 删除所有 Markdown 文档（.md）
        run: |
          set -e
          DIST_DIR="/tmp/isw_v2-dist"
          echo "删除公开仓库中的所有 .md 文档，目录: $DIST_DIR"
          find "$DIST_DIR" -name "*.md" -type f -print -delete || true

      - name: 更新 latest_build tag
        if: env.SKIP_BUILD != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          LATEST_BUILD_TAG="latest_build"
          CURRENT_COMMIT="${{ github.sha }}"
          GITHUB_REPO="${{ github.repository }}"
          
          echo "更新 latest_build tag 到当前 commit: $CURRENT_COMMIT"
          
          # 配置 git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 使用 x-access-token 前缀来避免 token 被误识别为密码
          # 设置远程 URL 使用 token 认证
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
          
          # 获取最新的远程信息
          git fetch origin --tags --force
          
          # 删除旧的 latest_build tag（如果存在）
          if git rev-parse "$LATEST_BUILD_TAG" >/dev/null 2>&1; then
            echo "删除本地 latest_build tag"
            git tag -d "$LATEST_BUILD_TAG" 2>/dev/null || true
          fi
          
          # 删除远程 latest_build tag（如果存在）
          if git ls-remote --tags origin "$LATEST_BUILD_TAG" | grep -q "$LATEST_BUILD_TAG"; then
            echo "删除远程 latest_build tag"
            git push origin ":refs/tags/$LATEST_BUILD_TAG" 2>/dev/null || true
          fi
          
          # 创建新的 latest_build tag（指向当前提交）
          git tag -a "$LATEST_BUILD_TAG" -m "Latest build commit: $CURRENT_COMMIT - $(date +'%Y-%m-%d %H:%M:%S')" "$CURRENT_COMMIT"
          git push origin "$LATEST_BUILD_TAG"
          
          echo "latest_build tag 已更新: $CURRENT_COMMIT"

      - name: 推送到 Gitee eztcloud-dist 仓库
        if: env.SKIP_BUILD != 'true'
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USER: children1987
        run: |
          set -e

          if [ -z "$GITEE_TOKEN" ]; then
            echo "错误: GITEE_TOKEN 未设置"
            exit 1
          fi

          GITEE_REPO="https://gitee.com/hotanzn/eztcloud-dist.git"
          TEMP_REPO="$(mktemp -d)"

          echo "克隆 Gitee 仓库..."
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/hotanzn/eztcloud-dist.git" "$TEMP_REPO"

          cd "$TEMP_REPO"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          echo "清空目标仓库内容（保留 .git）..."
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} + 2>/dev/null || true

          echo "复制编译结果到 Gitee 工作副本..."
          cp -r "/tmp/isw_v2-dist/." "$TEMP_REPO/"

          echo "提交并推送..."
          git add -A
          if git diff --staged --quiet; then
            echo "没有变更需要提交"
            exit 0
          fi

          COMMIT_MSG="Auto build isw_v2-dist from GitHub Actions (增量编译) - $(date +'%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          git push "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/hotanzn/eztcloud-dist.git" HEAD:master
          echo "推送完成"

