name: build-and-push-to-gitee

on:
  # 仅手动触发
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout isw_v2 源码
        uses: actions/checkout@v4

      - name: 安装 Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 安装编译依赖 (Cython, setuptools)
        run: |
          python -m pip install --upgrade pip
          # 优先使用官方 PyPI，避免国内镜像上 Cython 版本不全导致安装失败
          pip install --no-cache-dir "cython==3.0.11" setuptools || \
          pip install --no-cache-dir cython setuptools

      - name: 获取 isw-helper 编译工具
        run: |
          set -e
          echo "克隆 isw-helper 仓库..."
          rm -rf /tmp/isw-helper
          git clone --depth 1 https://gitee.com/hotanzn/isw-helper.git /tmp/isw-helper

          if [ ! -f "/tmp/isw-helper/build_cython.py" ]; then
            echo "错误: /tmp/isw-helper 中未找到 build_cython.py"
            exit 1
          fi

      - name: 编译 isw_v2 源码为 .so
        run: |
          set -e
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          # 使用独立的临时输出目录，避免与源码树产生上下级关系
          DIST_DIR="/tmp/isw_v2-dist"
          rm -rf "$DIST_DIR"
          mkdir -p "$DIST_DIR"

          cd /tmp/isw-helper

          python build_cython.py \
            --source "$GITHUB_WORKSPACE" \
            --target "$DIST_DIR" \
            --platform linux \
            --exclude "test" \
            --exclude "tests" \
            --exclude "__pycache__" \
            --exclude ".git"

          echo "编译完成，输出目录: $DIST_DIR"

      - name: 清理多余的 .py 源码文件
        run: |
          set -e
          DIST_DIR="/tmp/isw_v2-dist"
          echo "开始清理多余的 .py 文件，目录: $DIST_DIR"

          # 删除那些已经有对应 .so 的 .py，只保留少量必要入口文件
          find "$DIST_DIR" -name "*.py" | while read -r py; do
            base="$(basename "$py")"

            # 注意：deploy 目录下的文件已在编译阶段统一保留为源码（build_cython_delta.py::_should_keep）
            # 不会被编译，因此不会有对应的 .so，清理阶段也不会删除它们，无需在此保护

            stem="${py%.py}"
            # 同目录下存在同名的 cpython-*.so 或 .so，则认为 .py 可以删除
            if compgen -G "${stem}.cpython-"*".so" > /dev/null || [ -f "${stem}.so" ]; then
              echo "删除多余源码: $py"
              rm -f "$py"
            fi
          done

          echo "清理完成"

      - name: 删除所有 Markdown 文档（.md）
        run: |
          set -e
          DIST_DIR="/tmp/isw_v2-dist"
          echo "删除公开仓库中的所有 .md 文档，目录: $DIST_DIR"
          find "$DIST_DIR" -name "*.md" -type f -print -delete || true

      - name: 推送到 Gitee eztcloud-dist 仓库
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USER: children1987
        run: |
          set -e

          if [ -z "$GITEE_TOKEN" ]; then
            echo "错误: GITEE_TOKEN 未设置"
            exit 1
          fi

          GITEE_REPO="https://gitee.com/hotanzn/eztcloud-dist.git"
          TEMP_REPO="$(mktemp -d)"

          echo "克隆 Gitee 仓库..."
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/hotanzn/eztcloud-dist.git" "$TEMP_REPO"

          cd "$TEMP_REPO"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          echo "清空目标仓库内容（保留 .git）..."
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} + 2>/dev/null || true

          echo "复制编译结果到 Gitee 工作副本..."
          cp -r "/tmp/isw_v2-dist/." "$TEMP_REPO/"

          echo "提交并推送..."
          git add -A
          if git diff --staged --quiet; then
            echo "没有变更需要提交"
            exit 0
          fi

          COMMIT_MSG="Auto build isw_v2-dist from GitHub Actions - $(date +'%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          git push "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/hotanzn/eztcloud-dist.git" HEAD:master
          echo "推送完成"

